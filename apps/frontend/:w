import type { ReactNode } from "react";
import {
  extractAcknowledgement,
  extractAttribute,
  type CommandHistoryEntry,
} from "./utils";
import { stringifyValue } from "@/lib/utils";
import { Separator } from "@/components/ui/separator";

export function CommandDetail({ command }: { command: CommandHistoryEntry }) {
  return (
    <div className="text-sm flex flex-row gap-2 items-stretch">
      <DetailTable command={command} />
      <Separator orientation="vertical" />
      <AcknowledgementTraceTimeline command={command} />
    </div>
  );
}

function Label({ children }: { children: ReactNode }) {
  return <div className="font-sans text-xs text-orange-text">{children}</div>;
}

function AcknowledgementTraceTimeline({
  command,
}: {
  command: CommandHistoryEntry;
}) {
  const gsQueued = extractAcknowledgement(command, "Queued");
  const gsReleased = extractAcknowledgement(command, "Released");
  const gsSent = extractAcknowledgement(command, "Sent");

  return (
    <div className="self-stretch aspect-video w-60 space-y-1 font-mono text-xs flex flex-col">
      <Label>Acknowledgement Traces</Label>
      <div>{JSON.stringify(gsQueued)}</div>
      <div>{JSON.stringify(gsReleased)}</div>
      <div>{JSON.stringify(gsSent)}</div>
    </div>
  );
}

function DetailTable({ command }: { command: CommandHistoryEntry }) {
  return (
    <div className="grid font-mono gap-2">
      <div className="space-y-0.5">
        <Label>Command</Label>
        <div>{command.commandName}</div>
      </div>
      <div className="space-y-0.5">
        <Label>Generation Time</Label>
        <div>{command.generationTime.toLocaleString()}</div>
      </div>
      <div className="space-y-0.5">
        <Label>Issuer</Label>
        <div>
          {`${stringifyValue(extractAttribute(command, "username"))} @${command.origin}`}
        </div>
      </div>
      <div className="space-y-0.5">
        <Label>Queue</Label>
        <div>{stringifyValue(extractAttribute(command, "queue"))}</div>
      </div>
    </div>
  );
}
